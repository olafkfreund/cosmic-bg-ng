# cosmic-bg

COSMIC session service which applies backgrounds to displays. A Wayland background daemon for the COSMIC Desktop Environment (System76) with support for static wallpapers, colors/gradients, and GPU shader-based backgrounds.

## Features

### Implemented Features

#### Static Wallpapers
- Supports common image formats via [image-rs](https://github.com/image-rs/image#supported-image-formats)
- JPEG XL support via jxl-oxide
- 8-bit and 10-bit (HDR) surface rendering
- Colors and gradients for backgrounds
- Per-display background configuration
- Wallpaper slideshows with periodic rotation
- Shared image cache for memory efficiency

#### GPU Shaders (Work in Progress)
- **GPU Shaders**: Procedural animations using wgpu
  - Built-in presets: Plasma, Waves, Gradient
  - Custom WGSL shader support
  - FPS limiting for battery savings
  - **Note**: Shader configuration is defined but integration is still in development

#### Performance
- Asynchronous image loading (non-blocking I/O)
- Differential config updates (no full rebuild on changes)
- Frame timing synchronized with Wayland frame callbacks
- LRU image cache with configurable size
- Power-aware rendering for battery systems

#### Display Features
- HDR/10-bit display detection and rendering
- Output transform handling (90/180/270 degree rotation)
- Fractional scaling support
- Multi-monitor configurations

### Planned Features

#### Animated Wallpapers (Not Yet Implemented)
- **Animated Images**: GIF, APNG, and animated WebP with proper frame timing
- Currently only static frames from animated formats are displayed

#### Video Wallpapers (Not Yet Implemented)
- **Video Wallpapers**: MP4, WebM with GStreamer backend
  - Hardware-accelerated decoding (VA-API, NVDEC)
  - Loop playback and speed control
  - Audio muting (default)
- Configuration types and backend code are planned but not yet integrated

## Dependencies

### Build Dependencies
Developers should install Rust from https://rustup.rs/.

- just
- cargo / rustc (Rust 1.85+)
- libwayland-dev
- libxkbcommon-dev
- mold
- pkg-config

### Planned Optional Dependencies (for future features)
These will be needed when live wallpaper features are implemented:

- **GStreamer** (for video wallpapers - planned):
  - libgstreamer1.0-dev
  - libgstreamer-plugins-base1.0-dev
  - gstreamer1.0-plugins-good
  - gstreamer1.0-plugins-bad (for hardware acceleration)
- **wgpu** (for shader wallpapers - work in progress): GPU with Vulkan, Metal, or DX12 support

## Installation

A release build can be generated by running `just`, and then installed with `sudo just install`.

If packaging, use the `rootdir` variable to change the root path, in addition to the prefix: `just rootdir=debian/cosmic-bg prefix=/usr install`.

To reduce compile times across COSMIC applications, either use `sccache`, or set `CARGO_TARGET_DIR` to a shared path and install with `sudo -E just install`.

## Configuration

Configuration is stored via cosmic-config at `com.system76.CosmicBackground` (version 1).

### Static Wallpaper
```ron
(
    output: "all",
    source: Path("/usr/share/backgrounds/cosmic.jpg"),
    scaling_mode: Zoom,
    rotation_frequency: 3600,
)
```

### Color or Gradient Background
```ron
(
    output: "all",
    source: Color(Single([0.2, 0.4, 0.8])),  // RGB values 0.0-1.0
    scaling_mode: Zoom,
)
```

### GPU Shader (Work in Progress)
```ron
(
    output: "all",
    source: Shader(
        preset: Some(Plasma),
        custom_path: None,
        fps_limit: 30,
    ),
)
```

**Note**: The `Shader` source type is defined in configuration but shader rendering integration is still under development.

<!--
### Animated Image (Not Yet Implemented)
Animation and Video source types are planned but not yet available in the Source enum.
Future syntax may look like:
(
    output: "all",
    source: Animation(
        path: "/path/to/animation.gif",
        fps_limit: Some(30),
    ),
)

### Video Wallpaper (Not Yet Implemented)
(
    output: "all",
    source: Video(
        path: "/path/to/video.mp4",
        loop_playback: true,
        mute_audio: true,
        hw_accel: true,
    ),
)
-->

## Debugging

To get debug logs from the service, first kill the `cosmic-bg` process a few times in a row to prevent it from being launched by `cosmic-session`. Then launch it with `just run` to display backtraces and debug logs in the terminal.

```bash
# Enable detailed logging
RUST_LOG=cosmic_bg=debug just run

# Enable trace-level logging for frame timing
RUST_LOG=cosmic_bg=trace just run
```

## Architecture

### Current Structure
```
src/
├── main.rs          # Event loop, Wayland handlers, config watching
├── wallpaper.rs     # Wallpaper management and rendering
├── scaler.rs        # Image scaling (Fit, Zoom, Stretch)
├── draw.rs          # Buffer management and HDR rendering
├── colored.rs       # Solid colors and gradients
├── img_source.rs    # Filesystem watching for wallpaper directories
config/
├── lib.rs           # Configuration types (Entry, Source enum, etc.)
└── state.rs         # Persistent state for slideshow rotation
```

### Planned Components (Not Yet Implemented)
```
src/
├── source.rs        # WallpaperSource trait and implementations (planned)
├── animated.rs      # Animated image support - GIF, APNG, WebP (planned)
├── video.rs         # Video playback with GStreamer (planned)
├── shader.rs        # GPU shader wallpapers with wgpu (in progress)
├── cache.rs         # Shared LRU image cache (planned)
├── loader.rs        # Async image loading (planned)
├── scheduler.rs     # Frame timing and scheduling (planned)
├── error.rs         # Error types (planned)
└── shaders/         # Built-in WGSL shader presets (planned)
    ├── plasma.wgsl
    ├── waves.wgsl
    └── gradient.wgsl
```

## License

Licensed under the [Mozilla Public License Version 2.0](https://choosealicense.com/licenses/mpl-2.0).

### Contribution

Any contribution intentionally submitted for inclusion in the work by you shall be licensed under the Mozilla Public License Version 2.0 (MPL-2.0). Each source file should have a SPDX copyright notice at the top of the file:

```
// SPDX-License-Identifier: MPL-2.0
```
